<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Control</title>
        <script src="https://www.dropbox.com/s/025rtyufbzpnxos/mqttws31.min.js?dl=1" type="text/javascript"></script>
        <script src="https://www.dropbox.com/s/i7m61slcfhs8edk/jquery-2.2.4.min.js?dl=1" type="text/javascript"></script>
        <script src="https://www.dropbox.com/s/padbvplg3tc8nf0/bootstrap.min.js?dl=1" type="text/javascript"></script>
        <script src="https://www.dropbox.com/s/qbeqztuj7r8k52r/bootstrap-slider.min.js?dl=1" type="text/javascript"></script>
        <link rel="stylesheet" href="https://www.dropbox.com/s/xmj8sa5u6fpu39i/bootstrap_dark.min.css?dl=1">
        <style>.slider{display:inline-block;vertical-align:middle;position:relative}.slider.slider-horizontal{width:210px;height:20px}.slider.slider-horizontal .slider-track{height:10px;width:100%;margin-top:-5px;top:50%;left:0}.slider.slider-horizontal .slider-selection,.slider.slider-horizontal .slider-track-low,.slider.slider-horizontal .slider-track-high{height:100%;top:0;bottom:0}.slider.slider-horizontal .slider-tick,.slider.slider-horizontal .slider-handle{margin-left:-10px;margin-top:-5px}.slider.slider-horizontal .slider-tick.triangle,.slider.slider-horizontal .slider-handle.triangle{border-width:0 10px 10px 10px;width:0;height:0;border-bottom-color:#0480be;margin-top:0}.slider.slider-horizontal .slider-tick-label-container{white-space:nowrap;margin-top:20px}.slider.slider-horizontal .slider-tick-label-container .slider-tick-label{padding-top:4px;display:inline-block;text-align:center}.slider.slider-vertical{height:210px;width:20px}.slider.slider-vertical .slider-track{width:10px;height:100%;margin-left:-5px;left:50%;top:0}.slider.slider-vertical .slider-selection{width:100%;left:0;top:0;bottom:0}.slider.slider-vertical .slider-track-low,.slider.slider-vertical .slider-track-high{width:100%;left:0;right:0}.slider.slider-vertical .slider-tick,.slider.slider-vertical .slider-handle{margin-left:-5px;margin-top:-10px}.slider.slider-vertical .slider-tick.triangle,.slider.slider-vertical .slider-handle.triangle{border-width:10px 0 10px 10px;width:1px;height:1px;border-left-color:#0480be;margin-left:0}.slider.slider-vertical .slider-tick-label-container{white-space:nowrap}.slider.slider-vertical .slider-tick-label-container .slider-tick-label{padding-left:4px}.slider.slider-disabled .slider-handle{background-image:-webkit-linear-gradient(top,#dfdfdf 0,#bebebe 100%);background-image:-o-linear-gradient(top,#dfdfdf 0,#bebebe 100%);background-image:linear-gradient(to bottom,#dfdfdf 0,#bebebe 100%);background-repeat:repeat-x;filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffdfdfdf',endColorstr='#ffbebebe',GradientType=0)}.slider.slider-disabled .slider-track{background-image:-webkit-linear-gradient(top,#e5e5e5 0,#e9e9e9 100%);background-image:-o-linear-gradient(top,#e5e5e5 0,#e9e9e9 100%);background-image:linear-gradient(to bottom,#e5e5e5 0,#e9e9e9 100%);background-repeat:repeat-x;filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffe5e5e5',endColorstr='#ffe9e9e9',GradientType=0);cursor:not-allowed}.slider input{display:none}.slider .tooltip.top{margin-top:-36px}.slider .tooltip-inner{white-space:nowrap;max-width:none}.slider .hide{display:none}.slider-track{position:absolute;cursor:pointer;background-image:-webkit-linear-gradient(top,#f5f5f5 0,#f9f9f9 100%);background-image:-o-linear-gradient(top,#f5f5f5 0,#f9f9f9 100%);background-image:linear-gradient(to bottom,#f5f5f5 0,#f9f9f9 100%);background-repeat:repeat-x;filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#fff5f5f5',endColorstr='#fff9f9f9',GradientType=0);-webkit-box-shadow:inset 0 1px 2px rgba(0,0,0,0.1);box-shadow:inset 0 1px 2px rgba(0,0,0,0.1);border-radius:4px}.slider-selection{position:absolute;background-image:-webkit-linear-gradient(top,#f9f9f9 0,#f5f5f5 100%);background-image:-o-linear-gradient(top,#f9f9f9 0,#f5f5f5 100%);background-image:linear-gradient(to bottom,#f9f9f9 0,#f5f5f5 100%);background-repeat:repeat-x;filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#fff9f9f9',endColorstr='#fff5f5f5',GradientType=0);-webkit-box-shadow:inset 0 -1px 0 rgba(0,0,0,0.15);box-shadow:inset 0 -1px 0 rgba(0,0,0,0.15);-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;border-radius:4px}.slider-selection.tick-slider-selection{background-image:-webkit-linear-gradient(top,#89cdef 0,#81bfde 100%);background-image:-o-linear-gradient(top,#89cdef 0,#81bfde 100%);background-image:linear-gradient(to bottom,#89cdef 0,#81bfde 100%);background-repeat:repeat-x;filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#ff89cdef',endColorstr='#ff81bfde',GradientType=0)}.slider-track-low,.slider-track-high{position:absolute;background:transparent;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;border-radius:4px}.slider-handle{position:absolute;width:20px;height:20px;background-color:#337ab7;background-image:-webkit-linear-gradient(top,#149bdf 0,#0480be 100%);background-image:-o-linear-gradient(top,#149bdf 0,#0480be 100%);background-image:linear-gradient(to bottom,#149bdf 0,#0480be 100%);background-repeat:repeat-x;filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#ff149bdf',endColorstr='#ff0480be',GradientType=0);filter:none;-webkit-box-shadow:inset 0 1px 0 rgba(255,255,255,.2),0 1px 2px rgba(0,0,0,.05);box-shadow:inset 0 1px 0 rgba(255,255,255,.2),0 1px 2px rgba(0,0,0,.05);border:0 solid transparent}.slider-handle.round{border-radius:50%}.slider-handle.triangle{background:transparent none}.slider-handle.custom{background:transparent none}.slider-handle.custom::before{line-height:20px;font-size:20px;content:'\2605';color:#726204}.slider-tick{position:absolute;width:20px;height:20px;background-image:-webkit-linear-gradient(top,#f9f9f9 0,#f5f5f5 100%);background-image:-o-linear-gradient(top,#f9f9f9 0,#f5f5f5 100%);background-image:linear-gradient(to bottom,#f9f9f9 0,#f5f5f5 100%);background-repeat:repeat-x;filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#fff9f9f9',endColorstr='#fff5f5f5',GradientType=0);-webkit-box-shadow:inset 0 -1px 0 rgba(0,0,0,0.15);box-shadow:inset 0 -1px 0 rgba(0,0,0,0.15);-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;filter:none;opacity:.8;border:0 solid transparent}.slider-tick.round{border-radius:50%}.slider-tick.triangle{background:transparent none}.slider-tick.custom{background:transparent none}.slider-tick.custom::before{line-height:20px;font-size:20px;content:'\2605';color:#726204}.slider-tick.in-selection{background-image:-webkit-linear-gradient(top,#89cdef 0,#81bfde 100%);background-image:-o-linear-gradient(top,#89cdef 0,#81bfde 100%);background-image:linear-gradient(to bottom,#89cdef 0,#81bfde 100%);background-repeat:repeat-x;filter:progid:DXImageTransform.Microsoft.gradient(startColorstr='#ff89cdef',endColorstr='#ff81bfde',GradientType=0);opacity:1}</style>
        <style>
            html {
              position: relative;
              min-height: 100%;
            }
            body {
              margin-bottom: 60px;
              padding-top: 65px;
            }
            .footer {
              position: absolute;
              bottom: 0;
              width: 100%;
              height: 60px;
              background-color: #151515;
              color: #888888;
            }
            .container {
              width: auto;
              max-width: 680px;
              padding: 0 15px;
            }
            .container .text-muted {
              margin: 20px 0;
            }
            .col-centered{
                float: none;
                margin: 0 auto;
            }
        </style>
    </head>
    <body>
        <nav class="navbar navbar-inverse navbar-fixed-top">
          <div class="container">
            <div class="navbar-header">
              <a class="navbar-brand" href="#">Control</a>
            </div>
          </div>
        </nav>
        <div class="container">
            <div class="well">
                <h5>E-stim</h5>
                <br>
                <div class="row">
                    <div class="col-xs-2">Level A</div>
                    <div class="col-xs-4">
                        <input type="text" class="span2" value="" data-slider-min="0" data-slider-max="255" data-slider-step="1" data-slider-tooltip="hide" data-slider-value="0" data-slider-id="level_a" id="slider_a" data-slider-handle="round" />
                    </div>
                </div>
                <div class="row" style="margin-top: 10px;">
                    <div class="col-xs-2">Level B</div>
                    <div class="col-xs-4">
                        <input type="text" class="span2" value="" data-slider-min="0" data-slider-max="255" data-slider-step="1" data-slider-tooltip="hide" data-slider-value="0" data-slider-id="level_b" id="slider_b" data-slider-handle="round" />
                    </div>
                </div>
                
                <div class="row" style="margin-top: 10px;">
                    <div class="col-xs-2">MA</div>
                    <div class="col-xs-4">
                        <input type="text" class="span2" value="" data-slider-min="0" data-slider-max="100" data-slider-step="1" data-slider-tooltip="hide" data-slider-value="0" data-slider-id="multiadjust" id="slider_ma" data-slider-handle="round" />
                    </div>
                </div>   
                <div class="row" style="margin-top: 10px;">
                    <div class="col-xs-2" style="line-height: 30px;">Mode</div>
                    <div class="col-xs-4">
                        <select id="mode" class="form-control input-sm">
                            <option value="0">Waves</option>
                            <option value="1">Stroke</option>
                            <option value="2">Climb</option>
                            <option value="3">Combo</option>
                            <option value="4">Intense</option>
                            <option value="5">Rhythm</option>
                            <option value="6">Split</option>
                            <option value="7">Random 1</option>
                            <option value="8">Random 2</option>
                            <option value="9">Orgasm</option>
                            <option value="10">Torment</option>
                            <option value="11">Phase 1</option>
                            <option value="12">Phase 2</option>
                            <option value="13">Phase 3</option>
                        </select>
                    </div>
                </div>   

                <br>
                <h5>Vibration</h5>
                <br>
                <div class="row">
                    <div class="col-xs-2">Level</div>
                    <div class="col-xs-4">
                        <span id="no_vib" style="display: none;"><i>Not supported</i></span>                        
                        <input type="text" class="span2" value="" data-slider-min="0" data-slider-max="255" data-slider-step="1" data-slider-tooltip="hide" data-slider-value="0" data-slider-id="level_vib" id="slider_vib" data-slider-handle="round" />
                    </div>
                </div>

                <br>
                <h5>Vacuum</h5>
                <br>
                <div class="row">
                    <div class="col-xs-2">Level</div>
                    <div class="col-xs-4">
                        <span id="no_vacuum"><i>Not supported</i></span>
                    </div>
                </div>

            </div>
        </div>
        <div class="modal fade" tabindex="-1" role="dialog" id="pwmodal">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Enter password</h4>
              </div>
              <div class="modal-body">
                  <p><input type="password" value="" id="pwinput"></p>
                  <!-- <input type="checkbox" id="pw-save"> Save -->
              </div>
              <div class="modal-footer">
                <button id="pwbutton" type="button" class="btn btn-primary">Connect</button>
              </div>
            </div><!-- /.modal-content -->
          </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
        <footer class="footer">
          <div class="container">
              <p class="text-muted"><span id="mqtt_status"></span><span id="dev_status"></span></p>
          </div>

        </footer>
        <script type="text/javascript">
            var mqtt;
            var level_a, level_b, multiadjust;
            var sync = false;
            var mode_sync = false;
            var data = {a: 0, b:0, ma: 0, mode: 0};
            var update_thread_id = 0;

            function connect(password) {

                $("#mqtt_status").html('Connecting...');

                mqtt = new Paho.MQTT.Client('m21.cloudmqtt.com', 35849, 'web_' + parseInt(Math.random() * 100, 10));

                var options = {
                    timeout: 3,
                    onSuccess: onConnected,
                    onFailure: function(message) {
                        if(message.errorCode !== 8) {
                            $("#mqtt_status").text("Retrying...");
                            console.log("Mqtt error: ");
                            console.log(message);
                            setTimeout(connect, 5000);
                        } else {
                            $("#mqtt_status").html('<span style="color: red;">Wrong Password!</span>');
                            document.cookie = 'pw=;expires=Thu, 01 Jan 1970 00:00:01 GMT;';
                        }
                    },
                    useSSL: true,
                    userName: 'web',
                    password: password
                };

                mqtt.onMessageArrived = onMessageArrived;
                mqtt.connect(options);
            }

            function onConnected() {
                console.log("Connected!");
                mqtt.subscribe('/device/status', {qos: 0});
                mqtt.subscribe('/device/controls', {qos: 0});
                mqtt.subscribe('/device/mode', {qos:0});

                $("#mqtt_status").text("Connected");
                $("#dev_status").text(" - Device is offline.");
            }

            function onMessageArrived(message) {

                var topic = message.destinationName;

                if(topic === '/device/status') {
                    var obj = JSON.parse(message.payloadString);

                    if(obj.status === 1) {
                        $("#dev_status").html(' - Device is <span style="color: green;">online</span>.');

                        clearInterval(update_thread_id);
                        update_thread_id = setInterval(update_thread, 100);

                    } else {
                        $("#dev_status").text(" - Device is offline.");

                        clearInterval(update_thread_id);

                        sync = false;
                        mode_sync = false;

                        mqtt.subscribe('/device/controls', {qos: 0});
                        mqtt.subscribe('/device/mode', {qos:0});
                    }

                    if(obj.vib !== 1) {
                        $('#no_vib').show();
                        $('#level_vib').hide();
                    } else {

                    }
                    
                } else if(topic === '/device/controls') {
                    if(!sync) {
                        mqtt.unsubscribe('/device/controls', {});
                        sync = true;

                        var obj = JSON.parse(message.payloadString);

                        level_a.setValue(obj.a);
                        level_b.setValue(obj.b);
                        multiadjust.setValue(obj.m);
                    }
                } else if(topic === '/device/mode') {
                    if(!mode_sync) {
                        mqtt.unsubscribe('/device/mode', {});
                        $("#mode").val(message.payloadString);
                        mode_sync = true;
                    }
                }

                console.log(message.destinationName);
            }

            function updateMode() {
                message = new Paho.MQTT.Message($("#mode").val());
                message.destinationName = "/device/mode";
                message.retained = true;
                mqtt.send(message);                
            }

            function update_thread() {
                var update_levels = false, update_mode = false;

                if(data.a != level_a.getValue()) {
                    data.a = level_a.getValue();
                    update_levels = true;
                }

                if(data.b != level_b.getValue()) {
                    data.b = level_b.getValue();
                    update_levels = true;
                }

                if(data.ma != multiadjust.getValue()) {
                    data.ma = multiadjust.getValue();
                    update_levels = true;
                }                

                if(data.mode != $("#mode").val()) {
                    data.mode = $("#mode").val();
                    update_mode = true;
                }

                if(update_levels) {
                    message = new Paho.MQTT.Message(JSON.stringify({
                        'a':level_a.getValue(),
                        'b':level_b.getValue(),
                        'm':multiadjust.getValue()
                    }));
                    message.destinationName = "/device/controls";
                    message.retained = true;
                    mqtt.send(message);

                }

                if(update_mode) {
                    message = new Paho.MQTT.Message($("#mode").val());
                    message.destinationName = "/device/mode";
                    message.retained = true;
                    mqtt.send(message);  
                }

            }

            $(document).ready(function() {

                var saved = false;

                level_a = $("#slider_a").slider({
                    formatter: function(value) {
                        return Math.floor((value * 99) / 255);
                    }
                }).data('slider');

                level_b = $("#slider_b").slider({
                    formatter: function(value) {
                        return Math.floor((value * 99) / 255);
                    }
                }).data('slider');

                multiadjust = $("#slider_ma").slider({}).data('slider');

                $("#slider_vib").slider({}).data('slider');
                $("#mode").change(updateMode)

                var ca = document.cookie.split(';');
                for(var i = 0; i <ca.length; i++) {

                    var c = ca[i];
                                                                  
                    while (c.charAt(0)==' ') {
                        c = c.substring(1);
                    }
                    if (c.indexOf('pw=') == 0) {
                        var pwd = c.substring('pw='.length,c.length);

                        saved = true;
                        connect(pwd);

                        break;
                    }
                }

                if(!saved) {
                    $('#pwmodal').modal('show');
                }

                $('#pwbutton').click(function(){
                    var pwd = $('#pwinput').val();

                    if($('#pw-save').is(':checked')) {
                        var d = new Date();
                        d.setTime(d.getTime() + (24*60*60*1000));
                        var expires = "expires="+ d.toUTCString();
                        document.cookie = "pw=" + pwd + "; " + expires;
                        console.log("pw=" + pwd + "; " + expires);
                    }

                    $('#pwmodal').modal('hide');
                    connect(pwd);
                });

            });
        </script>
    </body>
</html>
